{% extends "base.html" %}
{% block title %}安全中心{% endblock %}
{% block sidebar %}
				<ul id="main-menu" class="main-menu">
					<li class="opened">
						<a href="">
							<span class="title">账户管理</span>
						</a>
						<ul>
							<li>
								<a href="{{ url_for('main.user', id=current_user.uid) }}">
									<span class="title">个人资料</span>
								</a>
							</li>
							<li class="active">
								<a href="{{ url_for('auth.secure_center') }}">
									<span class="title">安全中心</span>
								</a>
							</li>
							<li>
								<a href="{{ url_for('auth.logout') }}">
									<span class="title">登出</span>
								</a>
							</li>
						</ul>						
					</li>
					<li>
						<a href="">
							<span class="title">设备管理</span>
						</a>
						<ul id="deviceListLeft">
							<li>
								<a href="{{ url_for('main.home') }}">
									<span class="title">全部设备</span>
								</a>
							</li>
						</ul>		
					</li>
				</ul>
{% endblock %}
{% block main %}
<nav class="navbar user-info-navbar" role="navigation">
	<!-- Right links for user info navbar -->
	<ul class="user-info-menu right-links list-inline list-unstyled">
		<li class="search-form"><!-- You can add "always-visible" to show make the search input visible -->
			<form method="get" action="extra-search.html">
				<input type="text" name="s" class="form-control search-field" placeholder="查找设备..." />
					<button type="submit" class="btn btn-link">
						<i class="linecons-search"></i>
					</button>
			</form>
		</li>
				
				
		<li class="dropdown user-profile">
			<a href="#" data-toggle="dropdown">
			{% if current_user.is_authenticated %}
				<img src="{{ current_user.gravatar(size=48) }}" alt="user-image" class="img-circle img-inline userpic-32" width="28" />
				<span>
					{{ current_user.nickname }}
					<i class="fa-angle-down"></i>
				</span>
			{% else %}
				<img src="{{ url_for('static', filename = 'assets/images/user-4.png') }}" alt="user-image" class="img-circle img-inline userpic-32" width="28" />
				<span>
					游客
					<i class="fa-angle-down"></i>
				</span>
			{% endif %}
			</a>
			{% if current_user.is_authenticated %}
				<ul class="dropdown-menu user-profile-menu list-unstyled">
					<li>
						<a href="{{ url_for('main.user', id = current_user.uid) }}"><i class="fa-suitcase"></i>账户资料</a>
					</li>
					<li>
						<a href="{{ url_for('main.home') }}"><i class="fa-dashboard"></i>设备管理</a>
					</li>
					<li>
						<a href="{{ url_for('main.edit_profile', id = current_user.uid) }}"><i class="fa-edit"></i>编辑信息</a>
					</li>
					<li>
						<a href="{{ url_for('auth.secure_center') }}"><i class="fa-unlock"></i>安全中心</a>
					</li>
					<li class="last">
						<a href="{{ url_for('auth.logout') }}"><i class="fa-sign-out"></i>登出</a>
					</li>
				</ul>
			{% else %}
				<ul class="dropdown-menu user-profile-menu list-unstyled">
					<li>
						<a href="{{ url_for('auth.register') }}">
							<i class="fa-space-shuttle"></i>
							注册
						</a>
					</li>
					<li class="last">
						<a href="{{ url_for('auth.login') }}">
							<i class="fa-sign-in"></i>
							登录
						</a>
					</li>
				</ul>
			{% endif %}
		</li>
	</ul>
</nav>

<div class="page-title">
	<div class="title-env">
		<h1 class="title">安全中心</h1>
		<p class="description"></p>
	</div>
	<div class="breadcrumb-env">
		<ol class="breadcrumb bc-1">
			<li>
				<a href="dashboard-1.html"><i class="fa-home"></i>主页</a>
			</li>
			<li>
				<a href="tables-basic.html">账户管理</a>
			</li>
			<li class="active">
				<strong>安全中心</strong>
			</li>
		</ol>
	</div>
</div>

		<div class="row">
			<div class="col-md-12">				
				<input type="hidden" id = "info_token" class = "form-control" value = "{{ current_user.token_hash }}">
				<input type="hidden" id="info_email" class = "form-control" value="{{ current_user.email }}">
				<div class="panel panel-default">
					<form role="form" id="form-edit-email" method="post" class="validate">
						<div class="form-group">
							<label class="control-label" for="email">更换绑定邮箱</label>
							<input id="email" name="email" type="text" class="form-control" placeholder="请输入您要更换的新邮箱" />
						</div>
						<div class="form-group">
							<label class="control-label" for="currentEmailPassword">当前密码</label>
							<input id="currentEmailPassword" name="currentEmailPassword" type="password" class="form-control"   placeholder="请输入当前密码" />
						</div>
						<div class="form-group">
							<button type="submit" class="btn btn-success">提交</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12">
				<div class="panel panel-default">
					<form role="form" id="form-edit-password" method="post" class="validate" name="myForm" action="#">
						<div class="form-group">
							<label for="currentPassword" class="control-label">当前密码</label>
							<input id="currentPassword" name="currentPassword" type="password" class="form-control" autocomplete="off" placeholder="请输入当前密码" />
						</div>
						<div class="form-group">
							<label for="newpassword" class="control-label">新密码</label>
							<input id="newPassword" name="newPassword" type="password" class="form-control" autocomplete="off" placeholder="请输入新密码" />
						</div>
						<div class="form-group">
							<label for="checkPassword" class="control-label">确认新密码</label>
							<input id="checkPassword" name="checkPassword" type="password" class="form-control" autocomplete="off" placeholder="请再次输入新密码以确认" />
						</div>
						<div class="form-group">
							<button type="submit" class="btn btn-success" onclick="">提交</button>
						</div>
					</form>
				</div>
			</div>
		</div>

{% endblock %}
			
{% block scripts %}
<script>
jQuery(document).ready(function($){
	setTimeout(function(){ $(".fade-in-effect").addClass('in'); }, 1);

	$("form#form-edit-email").validate({
		rules: {
			email: {
				required: true,
				email: true
			},
			currentEmailPassword: {
			    required: true
			}
		},
		messages: {
			email: {
				required: '请输入邮箱',
				email: '邮箱格式不合法'
			},
			currentEmailPassword: {
			    required: '当前密码不能为空'
			}
		},
		submitHandler: function(form){
			show_loading_bar(70);
			var opts = {
				"closeButton": true,
				"debug": false,
				"positionClass": "toast-top-full-width",
				"onclick": null,
				"showDuration": "5000",
				"hideDuration": "1000",
				"timeOut": "5000",
				"extendedTimeOut": "5000",
				"showEasing": "swing",
				"hideEasing": "linear",
				"showMethod": "fadeIn",
				"hideMethod": "fadeOut"
			};
			$.ajax({
				url: "{{ url_for('') }}",
				method: 'POST',
				dataType: 'json',
				data: {
					'request':JSON.stringify({
						'email': $(form).find('#email').val()
					})
				},
				success: function(resp){
					show_loading_bar({
						delay: .5,
						pct: 100,
						finish: function(){
							if(resp.code == 0 || resp.code == 1){
								toastr.error("尝试发送请求失败，请检查您填写项是否合法并重试！", "修改失败", opts);
								$passwd.select();
							} else if (resp.code == 4){
								toastr.success("您的请求已成功发送，一封确认邮件已经发送到您填写的邮箱，验证后即可完成邮箱的修改，请您注意查收！页面即将跳转到顶点云设备管理主界面。", "请求发送成功", opts);
								setTimeout("window.location.href = '{{ url_for('main.home') }}'", 4000);
							} else if (resp.code == 2) {
								toastr.error("您填写的电子邮箱已经被注册！", "您填写的信息需要变更", opts);
								$email.select();
							}
						}
					});
				}
			});
		}
	});

	$("form#form-edit-password").validate({
		rules: {
			currentPassword: {
				required: true,
				minlength: 8,
				maxlength: 32
			},
			newPassword:{
				required: true,
				minlength: 8,
				maxlength: 32
			},
			checkPassword: {
				required: true,
				equalTo: "#newPassword"
			}
		},
		messages: {
			currentPassword: {
				required: '请输入旧密码',
				minlength: '密码长度不能小于8字符',
				maxlength: '密码长度不能大于32字符'
			},
			newPassword:{
				required: '请输入新密码',
				minlength: '密码长度不能小于8字符',
				maxlength: '密码长度不能大于32字符'
			},
			checkPassword:{
				required: '请再次输入新密码',
				equalTo: '两次密码输入不一致'
			}
		},
		submitHandler: function(form){
			show_loading_bar(70); // Fill progress bar to 70% (just a given value)
			var opts = {
				"closeButton": true,
				"debug": false,
				"positionClass": "toast-top-full-width",
				"onclick": null,
				"showDuration": "5000",
				"hideDuration": "1000",
				"timeOut": "5000",
				"extendedTimeOut": "5000",
				"showEasing": "swing",
				"hideEasing": "linear",
				"showMethod": "fadeIn",
				"hideMethod": "fadeOut"
			};
			$.ajax({
				url: "{{ url_for('') }}",
				method: 'POST',
				dataType: 'json',
				data: {
					'request':JSON.stringify({
						'passwd': $(form).find('#currentPassword').val(),
						'passwd2': $(form).find('#checkPassword').val()
					})
				},
				success: function(resp){
					show_loading_bar({
						delay: .5,
						pct: 100,
						finish: function(){
							if (resp.code == 1){
								toastr.error("您的密码已修改成功，页面即将跳转到顶点云设备管理主界面。", "修改成功", opts);
							}
							else if (resp.code == 2){
								toastr.error("服务器异常，请稍后再试", "服务器异常", opts);
								$email.select();
							}
							else if (resp.code == 3){
								toastr.error("密码格式错误", "您填写的信息需要变更", opts);
							}
						}
					});
				}
			});
		}
	});

	$("form#form-edit-password .form-group:has(.form-control):first .form-control").focus();
	$("form#form-edit-email .form-group:has(.form-control):first .form-control").focus();
});
</script>
{% endblock %}